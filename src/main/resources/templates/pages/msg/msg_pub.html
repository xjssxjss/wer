<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:include="/common/header::header('发布公告')">
</head>

<body ontouchstart class="page">
    <div class="weui-flex">
        <div class="weui-flex__item">
            <div class="placeholder">- 新增通知公告 -</div>
        </div>
    </div>
    <form id="messageForm">

        <div class="weui-cells weui-cells_form">
            <div class="weui-cells__title">公告标题</div>
            <div class="weui-cells">
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" name="msgTitle" placeholder="请输入公告标题">
                    </div>
                </div>
            </div>

            <div class="weui-cell">
                <div class="weui-cell__hd"><label for="startDate" class="weui-label">生效日期</label></div>
                <div class="weui-cell__bd">
                    <input id="startDate" name="msgStartDate" class="weui-input" type="date" value="">
                </div>
            </div>
            <div class="weui-cells__tips">公告生效选择范围必须在当前日期以及当前日期之后</div>

            <div class="weui-cell">
                <div class="weui-cell__hd"><label for="endDate" class="weui-label">失效日期</label></div>
                <div class="weui-cell__bd">
                    <input id="endDate" name="msgEndDate" class="weui-input" type="date" value="">
                </div>
            </div>
            <div class="weui-cells__tips">公告失效选择范围必须在当前日期以及当前日期之后</div>

            <div class="weui-cells__title">公告详细内容</div>
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <textarea id="myArea2" name="msgContent" class="weui-textarea" placeholder="请输入文本" rows="3"></textarea>
                </div>
            </div>

            <!-- 上传附件 -->
            <div class="weui-cell">
                <div class="weui-cell__bd weui_cell_primary">
                    <div class="weui-uploader">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">图片上传</p>
                            <div class="weui-uploader__info">0/1</div>
                        </div>
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files" id="uploaderFiles">

                            </ul>
                            <div class="weui-uploader__input-box">
                                <input  onchange="previewImage(this)" id="uploaderInput" class="weui-uploader__input" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple="">
                            </div>
                        </div>
                        <div class="weui_cell_bd weui_cell_primary">最多上传1张，每张不超过5M，支持jpg,jpeg,png,gif</div>
                    </div>
                </div>
            </div>

            <a id="submitMessageClick" class="weui-btn weui-btn_default">马上提交</a>
        </div>
    </form>
</body>

<script type="text/javascript">
    tinymce.init({ selector:'textarea'});

    function Appendzero(obj) {
        if(obj<10) return "0" +""+ obj;
        else return obj;
    }

    //获取当前日期
    function getCurrDate() {
        var date = new Date();
        var year = date.getFullYear();
        var month = (date.getMonth()+1);
        var day = date.getDate();
        //返回当前日期
        return year+'-'+Appendzero(month)+'-'+Appendzero(day);
    }

    //预览上传图片效果，通知通告上传附件
    function previewImage(file) {
        // 允许上传的图片类型
        var allowTypes = ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'];
        // 1024KB，也就是 1MB
        var maxSize = 1024 * 1024;
        // 图片最大宽度
        var maxWidth = 300;
        // 最大上传图片数量
        var maxCount = 6;

        if (allowTypes.indexOf(file.files[0].type) === -1) {
            $.toptip('该类型不允许上传', 'error');
            return;
        }

        if (file.files[0].size > maxSize) {
            $.toptip('图片太大，不允许上传', 'error');
            return;
        }

        if ($('.weui-uploader__files').length >= maxCount) {
            $.toptip('最多只能上传' + maxCount + '张图片', 'error');
            return;
        }

        if (file.files && file.files[0]) {
            var reader = new FileReader();
            reader.onload = function (evt) {
                $.post("http://192.168.0.122:9999/wer/messageController/uploadMessageImage",{fileName:file.files[0].name,fileSize:file.files[0].size,imgbase64: encodeURIComponent(evt.target.result)},function(rs){
                    if(rs.success){
                        $(file).parent().prev().html('<li class="weui-uploader__file" style="background-image:url('+evt.target.result+')"><input value="'+rs.src+'"  type="hidden"  name="files" /></li>');
                        $.toptip('文件上传成功','success');
                    } else {
                        $.toptip('文件上传失败','error');
                    }
                },'json');
            };
            reader.readAsDataURL(file.files[0]);
        }
    }

    $(function () {
        $('#startDate').click(function () {
            $('#startDate').attr('min',getCurrDate());
        });

        $('#endDate').click(function () {
            $('#endDate').attr('min',getCurrDate());
        });

        //当点击提交的时候判断
        $('#submitMessageClick').click(function () {
            $.showLoading('保存中');
            var jsonParam = $('form').serializeObject();
            //tinyMCE.editors[0].getContent() ，获取编辑器中公告详情信息
            jsonParam.msgContent = tinyMCE.editors[0].getContent();

            $.ajax({
                url:'http://192.168.0.122:9999/wer/messageController/saveMessage',
                method:'post',
                data:{jsonParam:JSON.stringify(jsonParam)},
                dataType:'json',
                success:function (res) {
                    if(res.success){
                        $.toptip('保存成功', 'success');
                        //保存成功之后清空表单
                        $('form')[0].reset();
                    } else {
                        if(null == res.data){
                            $.alert(res.message);
                        } else {
                            $.alert(res.data, res.message);
                        }
                    }
                },
                error:function (err) {
                    $.toptip('保存失败', 'error');
                }
            });
            $.hideLoading();
        });
    });
</script>
</html>
